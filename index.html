<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparky Pro | Electrician Portal</title>
    <style>
        :root { --primary: #ffcc00; --dark: #121212; --success: #28a745; --text: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: #f9f9f9; color: var(--text); }
        
        /* Layout */
        header { background: var(--dark); color: var(--primary); padding: 2rem 1rem; text-align: center; clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); }
        .container { max-width: 1100px; margin: -30px auto 50px; padding: 0 15px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* Gallery Grid */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .work-item { background: white; border-radius: 10px; overflow: hidden; border: 1px solid #eee; transition: 0.3s; }
        .work-item:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .work-item img { width: 100%; height: 220px; object-fit: cover; background: #f0f0f0; }
        .work-content { padding: 15px; }

        /* Modern Inputs */
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; outline: none; transition: 0.3s; font-size: 16px; }
        input:focus { border-color: var(--primary); }
        button { background: var(--primary); color: var(--dark); border: none; padding: 14px; font-weight: 700; border-radius: 8px; cursor: pointer; width: 100%; text-transform: uppercase; letter-spacing: 1px; }
        button:hover { filter: brightness(0.9); }
        .btn-secondary { background: #eee; color: #666; width: auto; font-size: 12px; margin-top: 20px; }

        /* UI States */
        .hidden { display: none; }
        .loading-spinner { text-align: center; padding: 50px; color: #999; }
        .status-msg { padding: 10px; border-radius: 5px; margin: 10px 0; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<header>
    <h1>⚡ Professional Electrician</h1>
    <p>Admin Managed &bull; Real-time Updates</p>
</header>

<div class="container">
    
    <section class="card">
        <h2>Completed Projects</h2>
        <div id="gallery" class="gallery">
            <div class="loading-spinner">Loading work logs...</div>
        </div>
    </section>

    <section class="card">
        <h2>Get a Quick Quote</h2>
        <div id="custStatus"></div>
        <form id="customerForm">
            <input type="hidden" name="type" value="customer">
            <input type="text" name="name" placeholder="Full Name" required>
            <input type="email" name="email" placeholder="Email Address" required>
            <textarea name="message" rows="4" placeholder="Briefly describe your electrical issue..." required></textarea>
            <button type="submit">Submit Request</button>
        </form>
    </section>

    <center><button class="btn-secondary" onclick="toggleLogin()">Admin Login</button></center>

    <div id="loginSection" class="card hidden" style="max-width: 400px; margin: 20px auto;">
        <h3>Secure Admin Access</h3>
        <input type="text" id="user" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button onclick="doLogin()">Enter Panel</button>
    </div>

    <div id="adminPanel" class="card hidden">
        <h2 style="color: var(--success)">Upload Project</h2>
        <form id="adminForm">
            <input type="hidden" name="type" value="admin">
            <input type="text" name="jobTitle" placeholder="Project Title" required>
            <textarea name="description" placeholder="Details of the job"></textarea>
            <label>Upload JPG Photo:</label>
            <input type="file" id="imageInput" accept="image/jpeg" required>
            <input type="hidden" name="imageUrl" id="finalImage">
            <button type="submit" style="background: var(--success); color: white;">Publish to Site</button>
        </form>
        <button onclick="doLogout()" class="btn-secondary">Logout</button>
    </div>

</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxDRbKhrh1vhIjgBH1QDhNav7tHRaO-Ih_VQ0BuJ-4tZoUESfZfq6qJvQSkqgz6pixW/exec';
    
    // AUTH CONFIG
    const AUTH = { u: "admin", p: "sparky123" };

    // 1. IMAGE HANDLING (COMPRESSION)
    document.getElementById('imageInput').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);
                // Convert to compressed JPG
                document.getElementById('finalImage').value = canvas.toDataURL("image/jpeg", 0.7);
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    };

    // 2. ADMIN LOGIC
    function toggleLogin() { document.getElementById('loginSection').classList.toggle('hidden'); }
    
    function doLogin() {
        if(document.getElementById('user').value === AUTH.u && document.getElementById('pass').value === AUTH.p) {
            localStorage.setItem('isElectricianAdmin', 'true');
            showAdminUI();
        } else { alert("Invalid Credentials"); }
    }

    function showAdminUI() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
    }

    function doLogout() {
        localStorage.removeItem('isElectricianAdmin');
        location.reload();
    }

    // 3. DATA LOADING
    async function loadGallery() {
        const gallery = document.getElementById('gallery');
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            if(!data.length) { gallery.innerHTML = "<p>No projects uploaded yet.</p>"; return; }
            
            gallery.innerHTML = data.reverse().map(item => `
                <div class="work-item">
                    <img src="${item.img || ''}" loading="lazy">
                    <div class="work-content">
                        <h3>${item.title}</h3>
                        <p>${item.desc}</p>
                    </div>
                </div>
            `).join('');
        } catch (e) { gallery.innerHTML = "Error loading content."; }
    }

    // 4. FORM SUBMISSION
    async function initForm(formId) {
        document.getElementById(formId).onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "⏳ Processing...";
            btn.disabled = true;

            try {
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: new URLSearchParams(new FormData(e.target)) 
                });
                alert("Success! Data stored in Sheet.");
                location.reload();
            } catch (err) {
                alert("Submission failed.");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        };
    }

    // STARTUP
    if(localStorage.getItem('isElectricianAdmin')) showAdminUI();
    initForm('adminForm');
    initForm('customerForm');
    loadGallery();
</script>
</body>
</html>
